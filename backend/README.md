# Fujfajka Firebase Backend Service App

firebase deploy --only functions

### **Firebase**
To deploy:
```
firebase deploy --only functions
```

**Local Testing** <br />
You need local env file under `functions` folder called `.runtimeconfig.json` that contains proper setup like:

````
{
  "env": {
    "name": "production"
  }
}
````

Instal emulator:
`npm install -g firebase-tools`

To enable:
`firebase init emulators`

To start:
`firebase emulators:start`

or 
`npm run emulators:start `

TO MAKE SURE YOU SEE CODE CHANGES in the emulator run in the separate console:
`npm run build:watch`

**Switching accounts for staging/production projects**

Staging is using a personal account and different email.
Production is using a company account.

Firebase CLI supports multiple login sessions with the login:add and login:use commands. Here’s how you can set it up:

1. Login with Staging Account (Email 1)

If you’re already logged in with your staging account, you can skip this step. But if not:

```
firebase login:add --no-localhost
```
This will open a new authentication window where you can log in with your staging email (Email 1).

2. Add Production Account (Email 2)

Now, add a new session for your production email (Email 2) by running:

```
firebase login:add --no-localhost
```
Select your production Google account (Email 2) in the browser window that opens.

3. Switch Between Accounts

After adding both accounts, you can switch between them without logging out by using:

```
firebase login:use <email_address>
```
For example:

```
firebase login:use email1@example.com  # Staging account
firebase login:use email2@example.com  # Production account
```

*** Troubleshooting ***

If it says " Failed to get Firebase project XYZ. Please make sure the project exists and your account has permission to access it." you need to login again. You can do so by following the step 1 or 2. 

4. Set Up Aliases for Each Account
Once you’ve set up and switched to the correct account, you can add aliases for each project.

Switch to Staging Account and Add Alias for a Project

```
firebase login:use email1@example.com
firebase use --add
```
This will prompt you to select a project and apply an alias. 

Used aliases are:
- `staging`
- `production`

Read here: https://firebase.google.com/docs/cli#project_aliases

**Env Files**
You need `serviceAccountKey.staging.json` and `serviceAccountKey.production.json` files under `src` folder, to be able to publish functions (and work with notifications).

Setup env configs for functions:
````
firebase functions:config:set env.name="production" --project=production
firebase functions:config:set env.name="staging" --project=staging
````

**Troubleshooting**

`serviceAccountKey` file has to be copied into `lib` directory as well!

If you ever setup Firebase with a company account you need to grand permissions to a `-compute` email generated by Google Cloud to: 
- Artifact Registry Writer
- Log Writer
- Storage Object Viewer
This will enable functions deploy from the console.